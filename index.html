<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VWorld 주소 지도 표시 (웹)</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <style>
    :root{--bg:#0b1020;--panel:#11172c;--muted:#93a3c6;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:1.35rem;margin:0 0 8px}
    .hint{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input[type="text"], input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:var(--txt)}
    button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
    .progress{height:10px;background:#0f1530;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .bar{height:100%;background:linear-gradient(90deg,#688fff,#86a7ff)}
    .log{height:360px;overflow:auto;background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12.5px;white-space:pre}
    .note{color:#ffb4b4;white-space:pre-line}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#143268;color:#d7e4ff;font-size:.8rem;margin-left:.5rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
    .map-wrap{width:100vw}
    #map{width:100vw;height:100vh;background:#0f1530;border-top:1px solid var(--line);display:block}
    .leaflet-div-icon{background:transparent!important;border:0!important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>📍 VWorld 주소 지도 표시 <span class="pill">웹</span></h1>
    <div class="hint">엑셀/CSV의 <b>주소</b>, <b>구분</b>(선택), <b>동</b>(선택)을 읽어 지도에 표시합니다. 학교 주소는 입력란 또는 엑셀 <b>B2</b>(선택).</div>

    <div class="panel">
      <div class="hint">VWorld Key는 <code>Apps Script 프록시</code>에서 보관됩니다.</div>

      <label>데이터 파일 선택 (xlsx / xls / csv)</label>
      <input id="file" type="file" accept=".xlsx,.xls,.csv"/>

      <label>학교 기준 주소 (선택)</label>
      <input id="schoolAddr" type="text" placeholder="입력 시 반경/거리 라벨 표시"/>

      <div class="row" style="margin-top:10px">
        <button id="runBtn">지도에 표시</button>
        <button id="clearBtn">로그 지우기</button>
      </div>

      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      <div id="progLabel" class="hint" style="margin-top:6px"></div>

      <div class="note" style="margin-top:12px">⚠️ 주의
- 도로명인데 번지(숫자) 없으면 오류
- 단지명만은 불가
- 동/호수는 무시되고 ‘동’ 단위로 합산
- 호출 간격 0.2초(과다호출 방지)</div>

      <div id="log" class="log" style="margin-top:12px"></div>
      <div class="footer">Leaflet + VWorld(프록시) · 아래 내장 지도에 렌더링</div>
    </div>
  </div>

  <div class="map-wrap"><div id="map"></div></div>

<script>
const PROXY_BASE = 'https://script.google.com/macros/s/AKfycbwELVvtv8iNqyn6ltYMY2hr77w8F_Ksy34TDi9kMj6Qy5runtboRU6QSWlTjBAHzo5z/exec';

const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const log = msg => { const el=$('#log'); const t=new Date().toLocaleTimeString(); el.textContent += `[${t}] ${msg}\n`; el.scrollTop = el.scrollHeight; };
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function setProgress(done,total,current){ const pct= total? Math.round(done/total*100):0; $('#bar').style.width=pct+'%'; $('#progLabel').innerHTML = total? `진행률: ${done}/${total} (${pct}%)` + (current? `<br>현재: <code>${esc(current)}</code>`:'') : ''; }

function clean_address(a){
  a = String(a||'');
  a = a.replace(/\d+\s*동\s*\d+\s*호/g,'');
  a = a.replace(/\d+\s*동/g,'');
  a = a.replace(/\d+\s*호/g,'');
  a = a.replace(/[()]/g,' ');
  a = a.replace(/,/g,' ');
  a = a.replace(/\s+/g,' ').trim();
  return a;
}
function is_road_address(a){
  const road_keywords = ["로","길","대로","고가","나들목","순환로","로터리","번길"];
  const tokens = String(a||'').split(/\s+/);
  return tokens.some(tok => road_keywords.some(k => tok.endsWith(k)));
}
function shorten_address(a){
  return String(a||'').replace(/^(경기|경기도|서울|서울특별시|부산|부산광역시|대구|대구광역시|인천|인천광역시|광주|광주광역시|대전|대전광역시|울산|울산광역시|세종|세종특별자치시|제주|제주특별자치도)\s*(도\s*)?(?:용인시|광주시|하남시|성남시|수원시|고양시|부천시|안양시|안산시|남양주시|화성시|평택시)?\s*/,'').trim();
}
function extract_dong_counts(popup_texts){
  const m = new Map();
  (popup_texts||[]).forEach(t=>{ const x=String(t).match(/(\d{2,4}동)/); if(x){ m.set(x[1],(m.get(x[1])||0)+1); } });
  return m;
}
function build_tooltip_text(popup_texts){
  if(!popup_texts?.length) return '';
  const main_only = popup_texts[0].split('<br>')[0];
  const first = shorten_address(main_only);
  const total = popup_texts.length;
  const dm = extract_dong_counts(popup_texts);
  if(!dm.size) return `${first} [총 ${total}건]`;
  const items = Array.from(dm.entries()).map(([d,c])=>`- ${d}: ${c}건`);
  const lines=[]; for(let i=0;i<items.length;i+=2) lines.push(items.slice(i,i+2).join(',  '));
  return `${first} [총 ${total}건]<br>`+lines.join('<br>');
}

async function geocodeVWorld(address){
  const primary = is_road_address(address) ? 'road' : 'parcel';
  const order = primary==='road' ? ['road','parcel'] : ['parcel','road'];
  for (const type of order){
    const u = new URL(PROXY_BASE);
    u.searchParams.set('address', address);
    u.searchParams.set('type', type);
    u.searchParams.set('_ts', Date.now());
    try{
      const res = await fetch(u.toString(), { method:'GET', cache:'no-store' });
      const data = await res.json();
      if (data?.response?.status === 'OK' && data?.response?.result?.point){
        const p = data.response.result.point;
        if (data?.response?.refined?.text) log(`↳ 매칭: ${data.response.refined.text}`);
        return [parseFloat(p.y), parseFloat(p.x)];
      } else {
        log(`[VWorld/Proxy] FAIL(${type}) ${address}`);
      }
    }catch(e){
      log(`[VWorld/Proxy] EXCEPTION(${type}) ${address} → ${e.message}`);
    }
  }
  return null;
}

/* 지도 */
let MAP=null, MAP_LAYER=null;
function ensureMap(center=[37.5665,126.9780], zoom=12){
  if(!MAP){
    MAP = L.map('map').setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(MAP);
    MAP_LAYER = L.layerGroup().addTo(MAP);
    window.addEventListener('resize', ()=>setTimeout(()=>MAP.invalidateSize(), 50));
    setTimeout(()=>MAP.invalidateSize(), 50);
  }
}
function renderMap(payload){
  ensureMap(payload.center||[37.5665,126.9780], payload.zoom||13);
  MAP_LAYER.clearLayers();

  /* 반경: 회색 채움 제거 */
  if(payload.school && payload.school.coord){
    const [slat, slon] = payload.school.coord;
    const ranges=[500,1000,1500,2000,2500];
    const counts=new Map(ranges.map(r=>[r,0]));
    const hav=(a,b)=>{const R=6371000,toRad=d=>d*Math.PI/180;const dLat=toRad(b[0]-a[0]),dLon=toRad(b[1]-a[1]);const lat1=toRad(a[0]),lat2=toRad(b[0]);const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
    (payload.points||[]).forEach(p=>{ const d=hav([slat,slon],[p.lat,p.lon]); for(const r of ranges){ if(d<=r){ counts.set(r, counts.get(r)+p.count); break; } } });
    ranges.forEach(r=>{
      L.circle([slat, slon], {
        radius:r, color:'#666', weight:2, dashArray:'6 4',
        fill:false, fillOpacity:0   /* ← 채움 제거 */
      }).addTo(MAP_LAYER);
      const labelLat = slat + (r/1000)/111;
      const txt = r>=1000 ? (r/1000).toFixed(1)+`km (${counts.get(r)}건)` : r+`m (${counts.get(r)}건)`;
      L.marker([labelLat, slon], {icon:L.divIcon({className:'', html:`<div style="font-size:18px;font-weight:bold;white-space:nowrap;color:black">${txt}</div>`})}).addTo(MAP_LAYER);
    });
    L.circleMarker([slat,slon], {radius:6,color:'red',fill:true,fillColor:'red',fillOpacity:1}).bindTooltip('학교 기준점',{sticky:true}).addTo(MAP_LAYER);
  }

  const latlngs=[];
  (payload.points||[]).forEach(p=>{
    latlngs.push([p.lat,p.lon]);

    /* 마커 크기(면적 ∝ 건수) */
    const SCALE=0.5, BASE_R=8, MIN_R=4, MAX_R=28;
    let r = BASE_R * Math.sqrt(Math.max(1, p.count)) * SCALE;
    r = Math.max(MIN_R, Math.min(MAX_R, r));

    const popupHtml = '<ul style="margin:0;padding-left:16px">'+(p.popupTexts||[]).map(t=>'<li>'+t+'</li>').join('')+'</ul>';
    const tip = build_tooltip_text(p.popupTexts||[]);

    /* 더 진한 파란색 그라데이션 + 외곽선/그림자 */
    const iconHtml = `
      <div style="
        width:${r*2}px;height:${r*2}px;border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        font-weight:700;font-size:${Math.max(11, r*0.9)}px;
        color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);
        background: radial-gradient(circle at 35% 30%, #3a6cff 0%, #1f50ff 45%, #0032cc 100%);
        box-shadow:
          0 3px 12px rgba(0,0,0,.4),
          0 0 0 2px rgba(255,255,255,.95);
      ">
        ${p.count>1 ? p.count : ''}
      </div>`;

    const icon = L.divIcon({ className:'', iconSize:[r*2,r*2], iconAnchor:[r,r], html: iconHtml });

    L.marker([p.lat,p.lon], {icon})
      .bindPopup(popupHtml, {maxWidth:300})
      .bindTooltip('<div style="font-size:14px;font-family:\'맑은 고딕\'">'+tip+'</div>', {sticky:true})
      .addTo(MAP_LAYER);
  });

  if(latlngs.length===1) MAP.setView(latlngs[0], payload.zoom||14);
  else if(latlngs.length>1) MAP.fitBounds(latlngs,{padding:[30,30]});
  setTimeout(()=>MAP.invalidateSize(), 50);
}

/* 파일 로딩 */
async function readRowsFromFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(['xlsx','xls'].includes(ext)){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
    let b2=''; try{ b2=(ws['B2']&&ws['B2'].v)? String(ws['B2'].v).trim():''; }catch{}
    return {rows, b2};
  }else if(ext==='csv'){
    const text = await file.text(); const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
    return {rows: parsed.data, b2: ''};
  }else{ throw new Error('지원하지 않는 파일 형식입니다.'); }
}

/* 실행 */
$('#clearBtn').addEventListener('click', ()=>{ $('#log').textContent=''; $('#bar').style.width='0%'; $('#progLabel').textContent=''; });

$('#runBtn').addEventListener('click', async()=>{
  ensureMap(); $('#map').scrollIntoView({behavior:'smooth', block:'start'});
  const f = $('#file').files[0]; if(!f){ alert('데이터 파일을 선택해 주세요.'); return; }
  $('#log').textContent=''; setProgress(0,0); log('처리를 시작합니다.');

  let rows, b2; try{ const r=await readRowsFromFile(f); rows=r.rows; b2=r.b2||''; } catch(e){ alert(e.message); return; }

  let schoolAddr = ($('#schoolAddr').value||'').trim();
  if(!schoolAddr && b2){ schoolAddr=b2; log(`엑셀 B2에서 학교 주소 감지: ${schoolAddr}`); }

  const norm = s=>String(s||'').replace(/\s+/g,'').toLowerCase();
  const head = rows.length? Object.keys(rows[0]) : [];
  const colAddr = head.find(h=>['주소','address'].includes(norm(h))) || '주소';
  const colGubun= head.find(h=>['구분','category','type'].includes(norm(h))) || '구분';
  const colDong = head.find(h=>['동','building','dong'].includes(norm(h))) || '동';

  let schoolCoord=null;
  if(schoolAddr){
    log(`학교 기준 주소 지오코딩: ${schoolAddr}`);
    schoolCoord = await geocodeVWorld(schoolAddr);
    if(!schoolCoord) log('학교 주소 지오코딩 실패: 반경/거리 라벨은 생략됩니다.');
  }

  const total = rows.length; let done=0, success=0;
  const pointMap = new Map();

  for(const [i,row] of rows.entries()){
    const raw = String(row[colAddr]||'').trim();
    if(!raw){ log(`[오류] ${i+2}행: 주소 없음`); done++; setProgress(done,total); continue; }

    const main = raw;
    const gubun = String(row[colGubun]||'').trim();
    const dong  = String(row[colDong]||'').trim();

    const cleaned = clean_address(main);

    const tokens = cleaned.split(/\s+/);
    const last = tokens[tokens.length-1]||'';
    const isOnlyDong = (cleaned.endsWith('동') && tokens.length===1) || (last.endsWith('동') && !/\d/.test(last));
    const hasRoadButNoNumber = is_road_address(cleaned) && !/\b\d{1,5}\b/.test(cleaned);
    if(isOnlyDong || hasRoadButNoNumber){
      const reason = isOnlyDong ? '동만 기재됨' : '도로명인데 번지가 없음';
      log(`[오류] ${cleaned} → ${reason}`); done++; setProgress(done,total, cleaned); continue;
    }

    setProgress(done,total, cleaned); log(`지오코딩: ${cleaned}`);

    const coord = await geocodeVWorld(cleaned);
    await sleep(100);

    if(coord){
      success++;
      const key = coord.join(',');
      if(!pointMap.has(key)) pointMap.set(key,{lat:coord[0],lon:coord[1],popupTexts:[],count:0});
      const p = pointMap.get(key);
      p.count++;
      const lines=[cleaned];
      if(gubun==='아파트' && dong) lines.push(`${dong}동`);
      p.popupTexts.push(lines.join('<br>'));
      log(`성공: ${cleaned} → (${coord[0].toFixed(5)}, ${coord[1].toFixed(5)})`);
    }else{
      log(`[실패] ${cleaned} → 주소를 찾을 수 없습니다.`);
    }

    done++; setProgress(done,total, cleaned);
  }

  const points = Array.from(pointMap.values());
  if(points.length){
    const center=[points[0].lat, points[0].lon];
    const schoolBlock = (schoolCoord && Array.isArray(schoolCoord)) ? {coord:schoolCoord, address:schoolAddr} : null;
    renderMap({center, zoom:14, points, school: schoolBlock});
    log(`✅ 완료: 총 ${total}건 / 성공 ${success}건 / 실패 ${total-success}건`);
  }else{
    const fb = (schoolCoord && Array.isArray(schoolCoord))
      ? {center:schoolCoord, zoom:14, points:[], school:{coord:schoolCoord,address:schoolAddr}}
      : {center:[37.5665,126.9780], zoom:12, points:[]};
    renderMap(fb); log('⛔ 표시할 수 있는 주소가 없습니다.');
  }
});
</script>
</body>
</html>
