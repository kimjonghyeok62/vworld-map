<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ (ì›¹ ë²„ì „)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#11172c;--muted:#93a3c6;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:1.35rem;margin:0 0 8px}
    .hint{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input[type="text"], input[type="file"], select{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:var(--txt)
    }
    button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .progress{height:10px;background:#0f1530;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .bar{height:100%;background:linear-gradient(90deg,#688fff,#86a7ff)}
    .log{height:360px;overflow:auto;background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12.5px}
    #map{height:720px;border-radius:16px;border:1px solid var(--line)}
    .note{color:#ffb4b4;white-space:pre-line}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#143268;color:#d7e4ff;font-size:.8rem;margin-left:.5rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ <span class="pill">ì›¹ ë²„ì „</span></h1>
    <div class="hint">ì—‘ì…€(.xlsx/.xls) ë˜ëŠ” CSV íŒŒì¼ì˜ <b>ì£¼ì†Œ</b>, <b>êµ¬ë¶„</b>(ì„ íƒ), <b>ë™</b>(ì„ íƒ) ì»¬ëŸ¼ì„ ì½ì–´ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤. 
      í•™êµ ê¸°ì¤€ì ì€ <b>ì—‘ì…€ B2</b> ì…€(ì²« ì‹œíŠ¸)ì—ì„œ ìë™ ì¶”ì¶œí•˜ê±°ë‚˜, ì•„ë˜ ì…ë ¥ë€ì— ì§ì ‘ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

    <div class="grid">
      <div class="panel">
        <label>VWorld API Key</label>
        <input id="apikey" type="text" placeholder="ì˜ˆ) 4A1B2C3D... (í•„ìˆ˜)" />

        <label>ë°ì´í„° íŒŒì¼ ì„ íƒ (xlsx / xls / csv)</label>
        <input id="file" type="file" accept=".xlsx,.xls,.csv" />

        <label>í•™êµ ê¸°ì¤€ ì£¼ì†Œ (ë¯¸ì…ë ¥ ì‹œ: ì—‘ì…€ B2 ì…€ ê°’ ì‚¬ìš©)</label>
        <input id="schoolAddr" type="text" placeholder="ì˜ˆ) ê²½ê¸°ë„ ìš©ì¸ì‹œ ê¸°í¥êµ¬ ..." />

        <div class="row" style="margin-top:10px">
          <button id="runBtn" disabled>ì§€ë„ì— í‘œì‹œ</button>
          <button id="clearBtn">ì§€ìš°ê¸°</button>
        </div>

        <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
        <div id="progLabel" class="hint" style="margin-top:6px"></div>

        <div class="note" style="margin-top:12px">âš ï¸ ì£¼ì˜ì‚¬í•­
- 'ë¡œ', 'ê¸¸', 'ë™'ìœ¼ë¡œ ëë‚˜ëŠ” ì£¼ì†Œ ì¤‘ ë²ˆì§€ê°€ ì—†ëŠ” ê²½ìš° ì˜¤ë¥˜ ì²˜ë¦¬
- ì•„íŒŒíŠ¸ ë‹¨ì§€ëª…ë§Œì€ ë¶ˆê°€ (ì •í™•í•œ ì£¼ì†Œ í•„ìš”)
- ë™/í˜¸ìˆ˜ëŠ” ë¬´ì‹œë˜ê³  ì•„íŒŒíŠ¸ â€˜ë™â€™ ë‹¨ìœ„ë¡œ í•©ì‚° í‘œì‹œ
- ìš”ì²­ì€ 0.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ í˜¸ì¶œ (VWorld API ê³¼ë„ í˜¸ì¶œ ë°©ì§€)</div>

        <div id="log" class="log" style="margin-top:12px"></div>
        <div class="footer">ì œì‘: ë¸Œë¼ìš°ì € ì „ìš© ë‹¨ì¼ HTML Â· Leaflet + VWorld API</div>
      </div>

      <div class="panel" style="padding:8px">
        <div id="map"></div>
      </div>
    </div>
  </div>

<script>
// ====== ìœ í‹¸ ======
const $ = (sel) => document.querySelector(sel);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function log(msg){
  const el = $('#log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `[${time}] ${msg}` + "\n";
  el.scrollTop = el.scrollHeight;
}

function setProgress(done, total){
  const pct = total ? Math.round(done/total*100) : 0;
  $('#bar').style.width = pct + '%';
  $('#progLabel').textContent = total ? `ì§„í–‰ë¥ : ${done}/${total} (${pct}%)` : '';
}

function shortenAddress(addr){
  if(!addr) return '';
  const re = /^(ê²½ê¸°|ê²½ê¸°ë„|ì„œìš¸|ì„œìš¸íŠ¹ë³„ì‹œ|ë¶€ì‚°|ë¶€ì‚°ê´‘ì—­ì‹œ|ëŒ€êµ¬|ëŒ€êµ¬ê´‘ì—­ì‹œ|ì¸ì²œ|ì¸ì²œê´‘ì—­ì‹œ|ê´‘ì£¼|ê´‘ì£¼ê´‘ì—­ì‹œ|ëŒ€ì „|ëŒ€ì „ê´‘ì—­ì‹œ|ìš¸ì‚°|ìš¸ì‚°ê´‘ì—­ì‹œ|ì„¸ì¢…|ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ|ì œì£¼|ì œì£¼íŠ¹ë³„ìì¹˜ë„)\s*(ë„\s*)?(?:ìš©ì¸ì‹œ|ê´‘ì£¼ì‹œ|í•˜ë‚¨ì‹œ|ì„±ë‚¨ì‹œ|ìˆ˜ì›ì‹œ|ê³ ì–‘ì‹œ|ë¶€ì²œì‹œ|ì•ˆì–‘ì‹œ|ì•ˆì‚°ì‹œ|ë‚¨ì–‘ì£¼ì‹œ|í™”ì„±ì‹œ|í‰íƒì‹œ)?\s*/;
  return addr.replace(re, '').trim();
}

function extractDongCounts(popupTexts){
  const m = new Map();
  popupTexts.forEach(t=>{
    const mt = /(\d{2,4}ë™)/.exec(t);
    if(mt){ m.set(mt[1], (m.get(mt[1])||0)+1); }
  });
  return Array.from(m.entries()); // [dong, cnt]
}

function buildTooltipText(popupTexts){
  if(!popupTexts || !popupTexts.length) return '';
  const mainOnly = popupTexts[0].includes('<br>') ? popupTexts[0].split('<br>')[0] : popupTexts[0];
  const firstAddr = shortenAddress(mainOnly);
  const total = popupTexts.length;
  const dongs = extractDongCounts(popupTexts);
  if(!dongs.length) return `${firstAddr} [ì´ ${total}ê±´]`;
  const items = dongs.map(([dong,c])=>`- ${dong}: ${c}ê±´`);
  const lines = [];
  for(let i=0;i<items.length;i+=2){ lines.push(items.slice(i,i+2).join(', \u00A0 ')); }
  return `${firstAddr} [ì´ ${total}ê±´]<br>` + lines.join('<br>');
}

function cleanAddress(address){
  if(!address) return '';
  let s = address;
  s = s.replace(/\d+ë™\s*\d+í˜¸/g,'');
  s = s.replace(/\d+ë™/g,'');
  s = s.replace(/\d+í˜¸/g,'');
  s = s.replace(/[(),]/g,' ').replace(/\s+/g,' ').trim();
  return s;
}

function isRoadAddress(address){
  if(!address) return false;
  const tokens = address.split(/\s+/);
  const suffixes = ['ë¡œ','ê¸¸','ëŒ€ë¡œ','ê³ ê°€','ë‚˜ë“¤ëª©','ìˆœí™˜ë¡œ','ë¡œí„°ë¦¬'];
  const last = tokens[tokens.length-1]||'';
  return suffixes.some(sfx => last.endsWith(sfx));
}

function hasLotNumber(address){
  return /\b\d{1,5}\b/.test(address||'');
}

function onlyDong(address){
  const tokens = (address||'').trim().split(/\s+/);
  const last = tokens[tokens.length-1]||'';
  return (address.endsWith('ë™') && tokens.length===1) || (last.endsWith('ë™') && !/[0-9]/.test(last));
}

function haversineMeters(a,b){
  const R=6371000; // m
  const toRad = (d)=> d*Math.PI/180;
  const dLat = toRad(b[0]-a[0]);
  const dLon = toRad(b[1]-a[1]);
  const lat1 = toRad(a[0]);
  const lat2 = toRad(b[0]);
  const sinDLat = Math.sin(dLat/2), sinDLon=Math.sin(dLon/2);
  const h = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ====== VWorld ì§€ì˜¤ì½”ë”© ======
async function geocodeVWorld(address, key){
  const type = isRoadAddress(address) ? 'road' : 'parcel';
  const url = new URL('https://api.vworld.kr/req/address');
  url.search = new URLSearchParams({
    service:'address', request:'getcoord', version:'2.0', crs:'EPSG:4326',
    address, refine:'true', simple:'false', format:'json', type, key
  }).toString();
  try{
    const res = await fetch(url.toString());
    const data = await res.json();
    if(data?.response?.status === 'OK'){
      const p = data.response.result.point;
      return [parseFloat(p.y), parseFloat(p.x)]; // [lat, lon]
    }
  }catch(e){ /* ignore */ }
  return null;
}

// ====== ì§€ë„ ======
let map = L.map('map').setView([37.275,127.033], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

function clearMap(){
  layerGroup.clearLayers();
  setProgress(0,0);
  $('#progLabel').textContent='';
  $('#log').textContent='';
}

// ====== íŒŒì¼ ë¡œë”© ======
$('#file').addEventListener('change', ()=>{
  $('#runBtn').disabled = !$('#file').files.length;
});
$('#clearBtn').addEventListener('click', clearMap);

$('#runBtn').addEventListener('click', async()=>{
  const apikey = $('#apikey').value.trim();
  if(!apikey){ alert('VWorld API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  const f = $('#file').files[0];
  if(!f){ alert('ë°ì´í„° íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  clearMap();
  log('ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');

  const ext = f.name.split('.').pop().toLowerCase();
  let rows = [];
  let b2 = '';

  if(['xlsx','xls'].includes(ext)){
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:true});
    rows = json; // header ê¸°ë°˜
    // B2 ì…€ ì¶”ì¶œ
    b2 = (ws['B2'] && ws['B2'].v) ? String(ws['B2'].v).trim() : '';
  }else if(ext==='csv'){
    const text = await f.text();
    const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
    rows = parsed.data;
  }else{
    alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
    return;
  }

  const schoolInput = $('#schoolAddr').value.trim();
  const schoolAddr = schoolInput || b2 || '';
  if(!schoolAddr){
    alert('í•™êµ ê¸°ì¤€ ì£¼ì†Œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì…ë ¥ë€ì— ì§ì ‘ ì…ë ¥í•˜ì‹œê±°ë‚˜, ì—‘ì…€ B2 ì…€ì— ì£¼ì†Œë¥¼ ë„£ì–´ ì£¼ì„¸ìš”.');
    return;
  }

  // ì£¼ì†Œ ì»¬ëŸ¼ëª… ê°€ì´ë“œ
  const COL_ADDR = 'ì£¼ì†Œ';
  const COL_GUBUN = 'êµ¬ë¶„';
  const COL_DONG = 'ë™';

  // ì§„í–‰ìƒíƒœ
  const total = rows.length;
  let done = 0, success = 0;
  const coordCounts = new Map(); // key:"lat,lon" -> count
  const coordInfos = new Map();  // key -> [popupText]

  // í•™êµ ì¢Œí‘œ ë¨¼ì €
  log(`í•™êµ ê¸°ì¤€ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©: ${schoolAddr}`);
  let schoolCoord = await geocodeVWorld(schoolAddr, apikey);
  if(!schoolCoord){
    log('í•™êµ ì£¼ì†Œ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ì§€ë„ë¥¼ ê³„ì† ê·¸ë¦¬ì§€ë§Œ, ë°˜ê²½í‘œì‹œëŠ” ìƒëµë©ë‹ˆë‹¤.');
  }

  for(const [i,row] of rows.entries()){
    const raw = String(row[COL_ADDR]||'').trim();
    if(!raw){
      log(`[ì˜¤ë¥˜] ${i+2}í–‰: ì£¼ì†Œ ì—†ìŒ`);
      done++; setProgress(done,total); continue; }

    const main = raw.includes(',') ? raw.split(',')[0].trim() : raw;
    const suffix = raw.replace(main,'').replace(/^[,\s()]*/,'').trim();
    const gubun = String(row[COL_GUBUN]||'').trim();
    const dong = String(row[COL_DONG]||'').trim();
    const address = cleanAddress(main);

    const road = isRoadAddress(address);
    const roadNoLot = road && !hasLotNumber(address);
    const onlyD = onlyDong(address);

    if(roadNoLot || onlyD){
      log(`[ì˜¤ë¥˜] ${address} â†’ ì •í™•í•œ ë²ˆì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      done++; setProgress(done,total); continue;
    }

    const coord = await geocodeVWorld(address, apikey);
    await sleep(200); // rate-limit

    if(coord){
      success++;
      const key = coord.join(',');
      coordCounts.set(key, (coordCounts.get(key)||0)+1);
      const parts = [address];
      if(gubun==='ì•„íŒŒíŠ¸' && dong) parts.push(`${dong}ë™`);
      if(suffix) parts.push(suffix);
      const popupText = parts.join('<br>');
      if(!coordInfos.has(key)) coordInfos.set(key, []);
      coordInfos.get(key).push(popupText);
    }else{
      log(`[ì‹¤íŒ¨] ${address} â†’ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    }
    done++; setProgress(done,total);
  }

  // ì§€ë„ ê·¸ë¦¬ê¸°
  if(coordCounts.size){
    // ì¤‘ì‹¬ ì´ë™
    const firstKey = Array.from(coordCounts.keys())[0];
    const [lat,lon] = firstKey.split(',').map(Number);
    map.setView([lat,lon], 14);

    // í•™êµ ê¸°ì¤€ ì› & ë§ˆì»¤
    if(schoolCoord){
      const [slat, slon] = schoolCoord;
      const ranges = [500, 1000, 1500, 2000, 2500];
      const counts = new Map(ranges.map(r=>[r,0]));

      for(const key of coordCounts.keys()){
        const [clat, clon] = key.split(',').map(Number);
        const dist = haversineMeters([slat,slon],[clat,clon]);
        for(const r of ranges){ if(dist <= r){ counts.set(r, counts.get(r)+coordCounts.get(key)); break; } }
      }

      ranges.forEach(r=>{
        L.circle([slat, slon], {radius:r, color:'#808080', weight:1, dashArray:'5'}).addTo(layerGroup);
        const labelLat = slat + (r/1000)/111; // ë¶ìª½ìœ¼ë¡œ
        const labelText = r>=1000 ? `${(r/1000).toFixed(1)}km (${counts.get(r)}ê±´)` : `${r}m (${counts.get(r)}ê±´)`;
        L.marker([labelLat, slon], {icon: L.divIcon({className:'', html:
          `<div style="font-size:18px;color:black;font-weight:bold;text-align:center;line-height:1;white-space:nowrap;">${labelText}</div>`})
        }).addTo(layerGroup);
      });

      L.circleMarker([slat, slon], {radius:6, color:'red', fill:true, fillColor:'red', fillOpacity:1})
        .bindTooltip('í•™êµ ê¸°ì¤€ì ', {sticky:true})
        .addTo(layerGroup);
    }

    // ì¢Œí‘œë³„ ë§ˆì»¤
    for(const [key,count] of coordCounts.entries()){
      const coord = key.split(',').map(Number);
      const popupTexts = coordInfos.get(key)||[];
      const popupHtml = `<ul style="margin:0;padding-left:16px">${popupTexts.map(t=>`<li>${t}</li>`).join('')}</ul>`;
      const tooltip = buildTooltipText(popupTexts);

      // ë°˜ì§€ë¦„ ê³„ì‚° (ì› ì½”ë“œ ë¡œì§ ê·¼ì‚¬)
      const k = 0.1111; const maxR = 50;
      let r = count <= 100 ? Math.sqrt(count / k) : 30 + Math.log(count - 99);
      r = Math.min(r, maxR);

      L.circleMarker(coord, {radius:r, color:'blue', fill:true, fillColor:'blue', fillOpacity:0.8})
        .bindPopup(popupHtml, {maxWidth:300})
        .bindTooltip(`<div style="font-size:14px;font-family:'ë§‘ì€ ê³ ë”•'">${tooltip}</div>`, {sticky:true})
        .addTo(layerGroup);

      if(count>1){
        L.marker(coord, {icon: L.divIcon({className:'', iconSize:[r*2,r*2], iconAnchor:[r,r], html:
          `<div style="display:flex;justify-content:center;align-items:center;width:${r*2}px;height:${r*2}px;font-size:14px;color:white;font-weight:bold;font-family:'ë§‘ì€ ê³ ë”•',sans-serif;text-align:center;border-radius:50%;background:transparent;">${count}</div>`
        })}).bindTooltip(`<div style="font-size:14px;font-family:'ë§‘ì€ ê³ ë”•'">${tooltip}</div>`, {sticky:true}).addTo(layerGroup);
      }
    }

    log(`âœ… ì™„ë£Œ: ì´ ${rows.length}ê±´ / ì„±ê³µ ${success}ê±´ / ì‹¤íŒ¨ ${rows.length - success}ê±´`);
  }else{
    log('â›” í‘œì‹œí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
});
</script>
</body>
</html>
