<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ (ì›¹ ë²„ì „) â€” ë‚´ì¥ ì§€ë„</title>
  <!-- SheetJS for Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Leaflet for map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{--bg:#0b1020;--panel:#11172c;--muted:#93a3c6;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:1.35rem;margin:0 0 8px}
    .hint{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input[type="text"], input[type="file"], select{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:var(--txt)
    }
    button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .progress{height:10px;background:#0f1530;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .bar{height:100%;background:linear-gradient(90deg,#688fff,#86a7ff)}
    .log{height:360px;overflow:auto;background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12.5px}
    .note{color:#ffb4b4;white-space:pre-line}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#143268;color:#d7e4ff;font-size:.8rem;margin-left:.5rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
    #map{width:100vw;min-height:360px;background:#0f1530;border-top:1px solid var(--line)}
  .map-wrap{width:100vw}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ <span class="pill">ì›¹ ë²„ì „ Â· ë‚´ì¥ ì§€ë„</span></h1>
    <div class="hint">ì—‘ì…€(.xlsx/.xls) ë˜ëŠ” CSV íŒŒì¼ì˜ <b>ì£¼ì†Œ</b>, <b>êµ¬ë¶„</b>(ì„ íƒ), <b>ë™</b>(ì„ íƒ) ì»¬ëŸ¼ì„ ì½ì–´ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤.<br>í•™êµ ê¸°ì¤€ ì£¼ì†Œ ì…ë ¥ì€ <b>ì„ íƒì‚¬í•­</b>ì´ë©°, ë¯¸ì…ë ¥ ì‹œ ë°˜ê²½í‘œì‹œëŠ” ìƒëµë©ë‹ˆë‹¤.</div>

    <div class="panel">
      <!-- 1) ìƒìˆ˜ API Key ì‚¬ìš© -->
      <div class="hint">VWorld API Key: <code>ìƒìˆ˜</code> ì‚¬ìš© (ì…ë ¥ ë¶ˆí•„ìš”)</div>

      <label>ë°ì´í„° íŒŒì¼ ì„ íƒ (xlsx / xls / csv)</label>
      <input id="file" type="file" accept=".xlsx,.xls,.csv" />

      <label>í•™êµ ê¸°ì¤€ ì£¼ì†Œ (ì„ íƒ)</label>
      <input id="schoolAddr" type="text" placeholder="ì…ë ¥ ì‹œì—ë§Œ ë°˜ê²½ ì›/ë¼ë²¨ í‘œì‹œ" />

      <div class="row" style="margin-top:10px">
        <button id="runBtn">ì§€ë„ì— í‘œì‹œ</button>
        <button id="clearBtn">ë¡œê·¸ ì§€ìš°ê¸°</button>
      </div>

      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      <div id="progLabel" class="hint" style="margin-top:6px"></div>

      <div class="note" style="margin-top:12px">âš ï¸ ì£¼ì˜ì‚¬í•­
- 'ë¡œ', 'ê¸¸' ë“± ë„ë¡œëª… ì£¼ì†Œì— ë²ˆì§€(ìˆ«ì)ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
- ì•„íŒŒíŠ¸ ë‹¨ì§€ëª…ë§Œì€ ë¶ˆê°€ (ì •í™•í•œ ì£¼ì†Œ í•„ìš”)
- ë™/í˜¸ìˆ˜ëŠ” ë¬´ì‹œë˜ê³  ì•„íŒŒíŠ¸ â€˜ë™â€™ ë‹¨ìœ„ë¡œ í•©ì‚° í‘œì‹œ
- ìš”ì²­ì€ 0.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ í˜¸ì¶œ (VWorld API ê³¼ë„ í˜¸ì¶œ ë°©ì§€)</div>

      <div id="log" class="log" style="margin-top:12px"></div>
      <div class="footer">ì œì‘: ë¸Œë¼ìš°ì € ì „ìš© ë‹¨ì¼ HTML Â· Leaflet + VWorld API Â· ê²°ê³¼ëŠ” ì•„ë˜ ë‚´ì¥ ì§€ë„ì— ë Œë”ë§</div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
  </div>

<script>
// ====== ìƒìˆ˜ API Key ======
const VWORLD_KEY = '21E28EA8-73D0-340C-9EA2-B0CDCA0809B5';

// ====== ìœ í‹¸ ======
const $ = (sel) => document.querySelector(sel);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
// Leaflet map instance & layer
let MAP = null;
let MAP_LAYER = null;

function log(msg){
  const el = $('#log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `[${time}] ${msg}` + "\n";
  el.scrollTop = el.scrollHeight;
}

function setProgress(done, total){
  const pct = total ? Math.round(done/total*100) : 0;
  $('#bar').style.width = pct + '%';
  $('#progLabel').textContent = total ? `ì§„í–‰ë¥ : ${done}/${total} (${pct}%)` : '';
}

// ====== VWorld ì§€ì˜¤ì½”ë”© ======
async function geocodeVWorld(address){
  const types = ['road','parcel'];
  for(const type of types){
    const url = new URL('https://api.vworld.kr/req/address');
    url.search = new URLSearchParams({
      service:'address', request:'getcoord', version:'2.0', crs:'EPSG:4326',
      address, refine:'true', simple:'false', format:'json', type, key: VWORLD_KEY
    }).toString();
    try{
      const res = await fetch(url.toString());
      const data = await res.json();
      if(data && data.response && data.response.status === 'OK' && data.response.result && data.response.result.point){
        const p = data.response.result.point;
        return [parseFloat(p.y), parseFloat(p.x)];
      }
    }catch(e){ console.error('VWorld ì˜¤ë¥˜', e); }
  }
  return null;
}

// ====== ê²°ê³¼ ì§€ë„ ë³„ë„ ì°½ì— ë Œë”ë§ ======
function resizeMapHeight(){
  const el = document.getElementById('map');
  if(!el) return;
  const top = el.getBoundingClientRect().top;
  const avail = window.innerHeight - top - 8;
  el.style.height = Math.max(avail, 360) + 'px';
}

function ensureMap(center=[37.5665,126.9780], zoom=12){
  if(!MAP){
    resizeMapHeight();
    MAP = L.map('map').setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(MAP);
    MAP_LAYER = L.layerGroup().addTo(MAP);
    window.addEventListener('resize', ()=>{ resizeMapHeight(); setTimeout(()=>MAP.invalidateSize(), 50); });
    setTimeout(()=>MAP.invalidateSize(), 200);
  }
}

function renderMapOnPage(payload){
  const center = payload.center || [37.5665,126.9780];
  const zoom = payload.zoom || 13;
  ensureMap(center, zoom);
  MAP_LAYER.clearLayers();

  if(payload.school && payload.school.coord){
    const [slat, slon] = payload.school.coord;
    const ranges = [500,1000,1500,2000,2500];
    const counts = new Map(ranges.map(r=>[r,0]));
    const hav = (a,b)=>{const R=6371000, toRad=d=>d*Math.PI/180; const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]); const lat1=toRad(a[0]), lat2=toRad(b[0]); const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h));};
    (payload.points||[]).forEach(p=>{ const d=hav([slat,slon],[p.lat,p.lon]); for(const r of ranges){ if(d<=r){ counts.set(r, counts.get(r)+p.count); break; } } });
    ranges.forEach(r=>{
      L.circle([slat, slon], {radius:r, color:'#808080', weight:1, dashArray:'5'}).addTo(MAP_LAYER);
      const labelLat = slat + (r/1000)/111;
      const labelText = r>=1000 ? (r/1000).toFixed(1)+`km (${counts.get(r)}ê±´)` : r+`m (${counts.get(r)}ê±´)`;
      L.marker([labelLat, slon], {icon:L.divIcon({className:'',html:`<div style=\"font-size:18px;color:black;font-weight:bold;white-space:nowrap;\">${labelText}</div>`})}).addTo(MAP_LAYER);
    });
    L.circleMarker([slat,slon], {radius:6,color:'red',fill:true,fillColor:'red',fillOpacity:1}).bindTooltip('í•™êµ ê¸°ì¤€ì ',{sticky:true}).addTo(MAP_LAYER);
  }

  const latlngs=[];
  (payload.points||[]).forEach(p=>{
    latlngs.push([p.lat,p.lon]);
    const k=0.1111, maxR=50; let r = p.count<=100 ? Math.sqrt(p.count/k) : 30 + Math.log(p.count-99); if(r>maxR) r=maxR;
    const popupHtml = '<ul style="margin:0;padding-left:16px">' + (p.popupTexts||[]).map(t=>'<'+'li>'+t+'</li>').join('') + '</ul>';
    const tt = (typeof buildTooltipText==='function') ? buildTooltipText(p.popupTexts||[]) : '';
    L.circleMarker([p.lat,p.lon], {radius:r,color:'blue',fill:true,fillColor:'blue',fillOpacity:0.8})
      .bindPopup(popupHtml,{maxWidth:300})
      .bindTooltip('<div style="font-size:14px;font-family:\'ë§‘ì€ ê³ ë”•\'">'+tt+'</div>',{sticky:true})
      .addTo(MAP_LAYER);
    if(p.count>1){
      L.marker([p.lat,p.lon], {icon:L.divIcon({className:'',iconSize:[r*2,r*2],iconAnchor:[r,r], html:`<div style=\"display:flex;justify-content:center;align-items:center;width:${r*2}px;height:${r*2}px;font-size:14px;color:white;font-weight:bold;font-family:ë§‘ì€ ê³ ë”•,sans-serif;text-align:center;border-radius:50%;background:transparent;\">${p.count}</div>`})})
        .bindTooltip('<div style="font-size:14px;font-family:\'ë§‘ì€ ê³ ë”•\'">'+tt+'</div>',{sticky:true})
        .addTo(MAP_LAYER);
    }
  });

  if(latlngs.length===1){ MAP.setView(latlngs[0], zoom); }
  else if(latlngs.length>1){ MAP.fitBounds(latlngs, {padding:[30,30]}); }

  resizeMapHeight();
  setTimeout(()=>MAP.invalidateSize(), 100);
}

// ====== íŒŒì¼ ë¡œë”© & ì²˜ë¦¬ ======
$('#runBtn').addEventListener('click', async()=>{
  // í¬ì¸íŠ¸ê°€ 0ì´ì–´ë„ ë¹ˆ ì§€ë„ ë¨¼ì € ë³´ì´ê²Œ ì´ˆê¸°í™”
  ensureMap();
  document.getElementById('map').scrollIntoView({behavior:'smooth', block:'start'});
  document.getElementById('map').scrollIntoView({behavior:'smooth', block:'start'});
  const f = $('#file').files[0];
  if(!f){ alert('ë°ì´í„° íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
  $('#log').textContent=''; setProgress(0,0); log('ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');

  const ext = f.name.split('.').pop().toLowerCase();
  let rows = [];
  if(['xlsx','xls'].includes(ext)){
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
  }else if(ext==='csv'){
    const text = await f.text();
    const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
    rows = parsed.data;
  } else { alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'); return; }

  const COL_ADDR='ì£¼ì†Œ';
  const COL_GUBUN='êµ¬ë¶„';
  const COL_DONG='ë™';
  const total = rows.length; let done=0,success=0;
  const pointMap=new Map();

  // (ì„ íƒ) í•™êµ ê¸°ì¤€ ì¢Œí‘œ
  const schoolAddr = $('#schoolAddr').value.trim();
  let schoolCoord = null;
  if(schoolAddr){
    log(`í•™êµ ê¸°ì¤€ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©: ${schoolAddr}`);
    schoolCoord = await geocodeVWorld(schoolAddr);
    if(!schoolCoord) log('í•™êµ ì£¼ì†Œ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ë°˜ê²½í‘œì‹œëŠ” ìƒëµë©ë‹ˆë‹¤.');
  }

  for(const [i,row] of rows.entries()){
    const raw = String(row[COL_ADDR]||'').trim();
    if(!raw){ log(`[ì˜¤ë¥˜] ${i+2}í–‰: ì£¼ì†Œ ì—†ìŒ`); done++; setProgress(done,total); continue; }

    const address = raw.includes(',') ? raw.split(',')[0].trim() : raw;
    const coord = await geocodeVWorld(address);
    await sleep(200);

    if(coord){
      success++;
      const key=coord.join(',');
      if(!pointMap.has(key)) pointMap.set(key,{lat:coord[0],lon:coord[1],popupTexts:[],count:0});
      const p=pointMap.get(key);
      p.count++;
      p.popupTexts.push(address);
    } else {
      log(`[ì‹¤íŒ¨] ${address} â†’ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    }
    done++; setProgress(done,total);
  }

  const points=Array.from(pointMap.values());
  if(points.length){
    const center=[points[0].lat,points[0].lon];
    renderMapOnPage({center,zoom:14,points, school: schoolCoord ? {coord: schoolCoord, address: schoolAddr} : null});
    log(`âœ… ì™„ë£Œ: ì´ ${rows.length}ê±´ / ì„±ê³µ ${success}ê±´ / ì‹¤íŒ¨ ${rows.length-success}ê±´`);
  } else {
    const fallback = schoolCoord ? {center: schoolCoord, zoom: 14, points: [], school: {coord: schoolCoord, address: schoolAddr}} : {center:[37.5665,126.9780], zoom:12, points: []};
    renderMapOnPage(fallback);
    log('â›” í‘œì‹œí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
});
</script>
</body>
</html>
