<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ (ì›¹ ë²„ì „) â€” ë‚´ì¥ ì§€ë„</title>

  <!-- SheetJS / PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <style>
    :root{--bg:#0b1020;--panel:#11172c;--muted:#93a3c6;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:1.35rem;margin:0 0 8px}
    .hint{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input[type="text"], input[type="file"], select{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:var(--txt)
    }
    button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .progress{height:10px;background:#0f1530;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .bar{height:100%;background:linear-gradient(90deg,#688fff,#86a7ff)}
    .log{height:360px;overflow:auto;background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12.5px;white-space:pre}
    .note{color:#ffb4b4;white-space:pre-line}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#143268;color:#d7e4ff;font-size:.8rem;margin-left:.5rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:10px}

    /* ì§€ë„ëŠ” í•­ìƒ ë·°í¬íŠ¸ ë†’ì´ë¡œ ê½‰ ì±„ìš°ê¸° */
    .map-wrap{width:100vw}
    #map{width:100vw;height:100vh;background:#0f1530;border-top:1px solid var(--line);display:block}

    /* ìˆ«ì ì˜¤ë²„ë ˆì´ ê¸°ë³¸ í° ë„¤ëª¨ ì œê±° */
    .leaflet-div-icon{background:transparent!important;border:0!important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ <span class="pill">ì›¹ ë²„ì „ Â· ë‚´ì¥ ì§€ë„</span></h1>
    <div class="hint">
      ì—‘ì…€(.xlsx/.xls) ë˜ëŠ” CSVì˜ <b>ì£¼ì†Œ</b>, <b>êµ¬ë¶„</b>(ì„ íƒ), <b>ë™</b>(ì„ íƒ) ì»¬ëŸ¼ì„ ì½ì–´ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤.<br>
      í•™êµ ê¸°ì¤€ ì£¼ì†ŒëŠ” <b>ì…ë ¥ë€</b> ë˜ëŠ” <b>ì—‘ì…€ B2</b>ì—ì„œ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.
    </div>

    <div class="panel">
      <div class="hint">VWorld API Key: <code>GAS í”„ë¡ì‹œì—ì„œ ë³´ê´€</code> (ë¸Œë¼ìš°ì € ë…¸ì¶œ ì—†ìŒ)</div>

      <label>ë°ì´í„° íŒŒì¼ ì„ íƒ (xlsx / xls / csv)</label>
      <input id="file" type="file" accept=".xlsx,.xls,.csv" />

      <label>í•™êµ ê¸°ì¤€ ì£¼ì†Œ (ì„ íƒ)</label>
      <input id="schoolAddr" type="text" placeholder="ì…ë ¥ ì‹œ ë°˜ê²½Â·ê±°ë¦¬ ë¼ë²¨ í‘œì‹œ. ë¯¸ì…ë ¥/ì‹¤íŒ¨ ì‹œ ë§ˆì»¤ë§Œ í‘œì‹œ" />

      <div class="row" style="margin-top:10px">
        <button id="runBtn">ì§€ë„ì— í‘œì‹œ</button>
        <button id="clearBtn">ë¡œê·¸ ì§€ìš°ê¸°</button>
      </div>

      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      <div id="progLabel" class="hint" style="margin-top:6px"></div>

      <div class="note" style="margin-top:12px">âš ï¸ ì£¼ì˜ì‚¬í•­
- 'ë¡œ', 'ê¸¸' ë“± ë„ë¡œëª… ì£¼ì†Œì— ë²ˆì§€(ìˆ«ì)ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
- ì•„íŒŒíŠ¸ ë‹¨ì§€ëª…ë§Œì€ ë¶ˆê°€ (ì •í™•í•œ ì£¼ì†Œ í•„ìš”)
- ë™/í˜¸ìˆ˜ëŠ” ë¬´ì‹œë˜ê³  ì•„íŒŒíŠ¸ â€˜ë™â€™ ë‹¨ìœ„ë¡œ í•©ì‚° í‘œì‹œ
- ìš”ì²­ì€ 0.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ í˜¸ì¶œ (VWorld API ê³¼ë„ í˜¸ì¶œ ë°©ì§€)</div>

      <div id="log" class="log" style="margin-top:12px"></div>
      <div class="footer">ì œì‘: ë¸Œë¼ìš°ì € ì „ìš© ë‹¨ì¼ HTML Â· Leaflet + VWorld API(GAS í”„ë¡ì‹œ) Â· ê²°ê³¼ëŠ” ì•„ë˜ ë‚´ì¥ ì§€ë„ì— ë Œë”ë§</div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
  </div>

<script>
/* ====== í”„ë¡ì‹œ ì„¤ì • ====== */
const PROXY_BASE =
  'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhESd22bY4rLZn8FmWUtzhlnCxmHTyXIGvDHu3ZFDGFGFeVl201xQCGElML2lxqNsQJ1bmpB46qiZM6ckJOlwAz0v4qELX9j8EIE7AX-zraN9x6zEuIeeBtrC-Fd9FPeqqYb14lX8y8DH6NFAavP0zppkGcKUIxbWeN9IVJiL8W3-gYA63pt0Upsagy8IFNy4tqjh5xo5rl-KZyefUEKi-9FucK7sXRtA40YI9luNVSqgZrkPc9ygt6KqE8fXBfBxrpSwLBUWfi-yQxA7Pp6T00sQdnniAt990h-PHl7_7shze4EV_lFezLLLiF6jhqPATMHArKrzot4j2xUs4_7g_nOypjnujLew-Rv_G14bu2TuH486kTpnmGHGn_Xq-mfFTAlLVhMzwIFw-vAuoGXsZ827FnD7n2AIsjRQiibMkchpRHR5GIp5bnT3p_-C73dAxsiuuu_6IejQxbk0c&lib=MQ7laLgDF9nfqmQtPYaGiikNuMfdVTsJR';

/* ====== ìœ í‹¸ ====== */
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r => setTimeout(r, ms));
function log(msg){ const el=$('#log'); const t=new Date().toLocaleTimeString(); el.textContent += `[${t}] ${msg}\n`; el.scrollTop = el.scrollHeight; }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function setProgress(done,total,currentLine){
  const pct = total ? Math.round(done/total*100) : 0;
  $('#bar').style.width = pct + '%';
  $('#progLabel').innerHTML = total
    ? `ì§„í–‰ë¥ : ${done}/${total} (${pct}%)` + (currentLine ? `<br>í˜„ì¬: <code>${esc(currentLine)}</code>` : '')
    : '';
}

/* ====== ì£¼ì†Œ ì „ì²˜ë¦¬/íŒë³„ ====== */
// ì‰¼í‘œ, ê´„í˜¸ëŠ” ì œê±°/ê³µë°±í™”ë§Œ í•˜ê³  'ì£¼ì†Œ ë³¸ë¬¸'ì€ ìë¥´ì§€ ì•ŠìŒ
function cleanAddress(a){
  a = String(a||'').trim();
  a = a.replace(/\d+\s*ë™\s*\d+\s*í˜¸/g,''); // 1502ë™ 703í˜¸
  a = a.replace(/\d+\s*ë™/g,'');           // 1502ë™
  a = a.replace(/\d+\s*í˜¸/g,'');           // 703í˜¸
  a = a.replace(/[()]/g,' ');              // ê´„í˜¸ë§Œ ê³µë°± ì²˜ë¦¬
  a = a.replace(/,/g,' ');                 // ì‰¼í‘œëŠ” ê³µë°±ìœ¼ë¡œ
  a = a.replace(/\s+/g,' ').trim();
  return a;
}

// ë„ë¡œëª…: 'ë¡œ|ê¸¸|ëŒ€ë¡œ|ë²ˆê¸¸' í† í° + ë’¤ì— 'ìˆ«ì(ë²ˆì§€)'ê°€ ì¡´ì¬
function isLikelyRoad(a){
  const s = String(a||'');
  return /(ë¡œ|ê¸¸|ëŒ€ë¡œ|ë²ˆê¸¸)\s*\d/.test(s);
}
// ì§€ë²ˆ: 'ë™ + ìˆ«ì' ë˜ëŠ” 'ìˆ«ì-ìˆ«ì' íŒ¨í„´
function isLikelyParcel(a){
  const s = String(a||'');
  return /(ë™|ë¦¬)\s*\d+(-\d+)?\b/.test(s) || /\b\d{1,5}-\d{1,5}\b/.test(s);
}

function shortenAddress(a){ return String(a||'').replace(
  /^(ê²½ê¸°|ê²½ê¸°ë„|ì„œìš¸|ì„œìš¸íŠ¹ë³„ì‹œ|ë¶€ì‚°|ë¶€ì‚°ê´‘ì—­ì‹œ|ëŒ€êµ¬|ëŒ€êµ¬ê´‘ì—­ì‹œ|ì¸ì²œ|ì¸ì²œê´‘ì—­ì‹œ|ê´‘ì£¼|ê´‘ì£¼ê´‘ì—­ì‹œ|ëŒ€ì „|ëŒ€ì „ê´‘ì—­ì‹œ|ìš¸ì‚°|ìš¸ì‚°ê´‘ì—­ì‹œ|ì„¸ì¢…|ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ|ì œì£¼|ì œì£¼íŠ¹ë³„ìì¹˜ë„)\s*(ë„\s*)?(?:ìš©ì¸ì‹œ|ê´‘ì£¼ì‹œ|í•˜ë‚¨ì‹œ|ì„±ë‚¨ì‹œ|ìˆ˜ì›ì‹œ|ê³ ì–‘ì‹œ|ë¶€ì²œì‹œ|ì•ˆì–‘ì‹œ|ì•ˆì‚°ì‹œ|ë‚¨ì–‘ì£¼ì‹œ|í™”ì„±ì‹œ|í‰íƒì‹œ)?\s*/,''
).trim(); }

function extractDongCounts(popupTexts){
  const m=new Map();
  (popupTexts||[]).forEach(t=>{
    const x=String(t).match(/(\d{2,4}ë™)/);
    if(x){ m.set(x[1],(m.get(x[1])||0)+1); }
  });
  return m;
}
function buildTooltipText(popupTexts){
  if(!popupTexts?.length) return '';
  const main=popupTexts[0].split('<br>')[0];
  const first=shortenAddress(main);
  const total=popupTexts.length;
  const dm=extractDongCounts(popupTexts);
  if(!dm.size) return `${first} [ì´ ${total}ê±´]`;
  const items=Array.from(dm.entries()).map(([d,c])=>`- ${d}: ${c}ê±´`);
  const lines=[]; for(let i=0;i<items.length;i+=2) lines.push(items.slice(i,i+2).join(',  '));
  return `${first} [ì´ ${total}ê±´]<br>`+lines.join('<br>');
}

/* ====== VWorld ì§€ì˜¤ì½”ë”©(í”„ë¡ì‹œ ê²½ìœ ) ====== */
async function geocodeVWorld(address){
  // ìš°ì„ ìˆœìœ„ ê²°ì •
  let order = ['road','parcel'];
  if (isLikelyParcel(address) && !isLikelyRoad(address)) order = ['parcel','road'];
  else if (!isLikelyParcel(address) && !isLikelyRoad(address)) order = ['road','parcel']; // ë¶ˆëª…í™•: ë‘˜ ë‹¤ ì‹œë„

  for (const type of order){
    const u = new URL(PROXY_BASE);
    u.searchParams.set('address', address);
    u.searchParams.set('type', type);
    try{
      const res = await fetch(u.toString(), { method:'GET' });
      const data = await res.json();

      if (data?.response?.status !== 'OK') {
        log(`[VWorld/Proxy] FAIL(${type}) ${address} â†’ ${data?.response?.error?.text || data?.response?.status || 'UNKNOWN_ERROR'}`);
      }

      if (data?.response?.status === 'OK' && data?.response?.result?.point) {
        const p = data.response.result.point;
        return [parseFloat(p.y), parseFloat(p.x)];
      }
    }catch(e){
      log(`[VWorld/Proxy] EXCEPTION(${type}) ${address} â†’ ${e.message}`);
    }
  }
  return null;
}

/* ====== ì§€ë„ ì„¸íŒ… ====== */
let MAP=null, MAP_LAYER=null;
function ensureMap(center=[37.5665,126.9780], zoom=12){
  if(!MAP){
    MAP = L.map('map').setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(MAP);
    MAP_LAYER = L.layerGroup().addTo(MAP);
    window.addEventListener('resize', ()=>setTimeout(()=>MAP.invalidateSize(), 50));
    setTimeout(()=>MAP.invalidateSize(), 50);
  }
}
function renderMap(payload){
  ensureMap(payload.center||[37.5665,126.9780], payload.zoom||13);
  MAP_LAYER.clearLayers();

  // í•™êµ ê¸°ì¤€ ì¢Œí‘œê°€ ìˆì„ ë•Œë§Œ ë°˜ê²½ ì›/ë¼ë²¨ í‘œì‹œ
  if (payload.school && payload.school.coord) {
    const [slat, slon] = payload.school.coord;
    const ranges=[500,1000,1500,2000,2500];
    const counts=new Map(ranges.map(r=>[r,0]));
    const hav=(a,b)=>{const R=6371000,toRad=d=>d*Math.PI/180;const dLat=toRad(b[0]-a[0]),dLon=toRad(b[1]-a[1]);const lat1=toRad(a[0]),lat2=toRad(b[0]);const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
    (payload.points||[]).forEach(p=>{ const d=hav([slat,slon],[p.lat,p.lon]); for(const r of ranges){ if(d<=r){ counts.set(r, counts.get(r)+p.count); break; } } });
    ranges.forEach(r=>{
      L.circle([slat, slon], {radius:r, color:'#808080', weight:1, dashArray:'5'}).addTo(MAP_LAYER);
      const labelLat = slat + (r/1000)/111;
      const labelText = r>=1000 ? (r/1000).toFixed(1)+`km (${counts.get(r)}ê±´)` : r+`m (${counts.get(r)}ê±´)`;
      L.marker([labelLat, slon], {icon:L.divIcon({className:'', html:`<div style="font-size:18px;font-weight:bold;white-space:nowrap;color:black">${labelText}</div>`})}).addTo(MAP_LAYER);
    });
    L.circleMarker([slat,slon], {radius:6,color:'red',fill:true,fillColor:'red',fillOpacity:1})
      .bindTooltip('í•™êµ ê¸°ì¤€ì ',{sticky:true}).addTo(MAP_LAYER);
  }

  const latlngs=[];
  (payload.points||[]).forEach(p=>{
    latlngs.push([p.lat,p.lon]);
    const k=0.1111, maxR=50;
    let r = p.count<=100 ? Math.sqrt(p.count/k) : 30 + Math.log(p.count-99);
    r = Math.min(maxR, Math.max(6, r)); // ìµœì†Œ ë°˜ì§€ë¦„ ë³´ì •

    const popupHtml = '<ul style="margin:0;padding-left:16px">'+(p.popupTexts||[]).map(t=>'<li>'+t+'</li>').join('')+'</ul>';
    const tip = buildTooltipText(p.popupTexts||[]);
    L.circleMarker([p.lat,p.lon], {
      radius:r, color:'#1e4fff', weight:1, fill:true, fillColor:'#3b6cff', fillOpacity:0.85
    })
      .bindPopup(popupHtml,{maxWidth:300})
      .bindTooltip('<div style="font-size:14px;font-family:\'ë§‘ì€ ê³ ë”•\'">'+tip+'</div>',{sticky:true})
      .addTo(MAP_LAYER);

    if(p.count>1){
      L.marker([p.lat,p.lon], {icon:L.divIcon({
        className:'', iconSize:[r*2,r*2], iconAnchor:[r,r],
        html:`<div style="
          display:flex;justify-content:center;align-items:center;
          width:${r*2}px;height:${r*2}px;border-radius:50%;
          font-size:14px;font-weight:700;color:#fff;
          text-shadow:0 1px 2px rgba(0,0,0,.6);
          background:rgba(0,0,0,.35);">${p.count}</div>`
      })})
        .bindTooltip('<div style="font-size:14px;font-family:\'ë§‘ì€ ê³ ë”•\'">'+tip+'</div>',{sticky:true})
        .addTo(MAP_LAYER);
    }
  });

  if(latlngs.length===1){ MAP.setView(latlngs[0], payload.zoom||14); }
  else if(latlngs.length>1){ MAP.fitBounds(latlngs,{padding:[30,30]}); }

  setTimeout(()=>MAP.invalidateSize(), 50);
}

/* ====== íŒŒì¼ ë¡œë”© ====== */
async function readRowsFromFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(['xlsx','xls'].includes(ext)){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
    let b2 = ''; try{ b2 = (ws['B2'] && ws['B2'].v) ? String(ws['B2'].v).trim() : ''; }catch{}
    return {rows, b2};
  }else if(ext==='csv'){
    const text = await file.text();
    const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
    return {rows: parsed.data, b2: ''};
  }else{
    throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
  }
}

/* ====== ì‹¤í–‰ ====== */
$('#clearBtn').addEventListener('click', ()=>{ $('#log').textContent=''; $('#bar').style.width='0%'; $('#progLabel').textContent=''; });

$('#runBtn').addEventListener('click', async()=>{
  ensureMap();
  $('#map').scrollIntoView({behavior:'smooth', block:'start'});

  const f = $('#file').files[0];
  if(!f){ alert('ë°ì´í„° íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  $('#log').textContent=''; setProgress(0,0); log('ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');

  let rows, b2;
  try{ const r = await readRowsFromFile(f); rows=r.rows; b2=r.b2 || ''; }
  catch(e){ alert(e.message); return; }

  let schoolAddr = ($('#schoolAddr').value||'').trim();
  if(!schoolAddr && b2){ schoolAddr=b2; log(`ì—‘ì…€ B2ì—ì„œ í•™êµ ì£¼ì†Œ ê°ì§€: ${schoolAddr}`); }

  const norm = s=>String(s||'').replace(/\s+/g,'').toLowerCase();
  const head = rows.length? Object.keys(rows[0]) : [];
  const colAddr = head.find(h=>['ì£¼ì†Œ','address'].includes(norm(h))) || 'ì£¼ì†Œ';
  const colGubun= head.find(h=>['êµ¬ë¶„','category','type'].includes(norm(h))) || 'êµ¬ë¶„';
  const colDong = head.find(h=>['ë™','building','dong'].includes(norm(h))) || 'ë™';

  let schoolCoord=null;
  if(schoolAddr){
    log(`í•™êµ ê¸°ì¤€ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©: ${schoolAddr}`);
    schoolCoord = await geocodeVWorld(schoolAddr);
    if(!schoolCoord) log('í•™êµ ì£¼ì†Œ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ë°˜ê²½Â·ê±°ë¦¬ ë¼ë²¨ì€ ìƒëµë©ë‹ˆë‹¤.');
  }

  const total = rows.length; let done=0, success=0;
  const pointMap = new Map();

  for (const [i,row] of rows.entries()){
    // â‘  ë”ëŠ” ì‰¼í‘œë¡œ ìë¥´ì§€ ì•ŠìŒ(ì „ì²´ ë¬¸ìì—´ ìœ ì§€)
    const raw = String(row[colAddr]||'').trim();
    if(!raw){ log(`[ì˜¤ë¥˜] ${i+2}í–‰: ì£¼ì†Œ ì—†ìŒ`); done++; setProgress(done,total); continue; }

    const main   = raw; // ì „ì²´ ì‚¬ìš©
    const suffix = '';  // íŒì—…ìš© ì¶”ê°€ í…ìŠ¤íŠ¸ëŠ” í•„ìš”ì‹œ ë‹¤ë¥¸ ì»¬ëŸ¼ìœ¼ë¡œ ë³´ê°•í•˜ì„¸ìš”

    const gubun  = String(row[colGubun]||'').trim();
    const dong   = String(row[colDong]||'').trim();

    const cleaned = cleanAddress(main);

    // ë²ˆì§€ ì—†ëŠ” ë„ë¡œëª…/ë™ë§Œ ê¸°ì¬ ê°ì§€
    const tokens = cleaned.split(/\s+/);
    const last = tokens[tokens.length-1]||'';
    const isOnlyDong = (cleaned.endsWith('ë™') && tokens.length===1) || (last.endsWith('ë™') && !/\d/.test(last));
    const hasRoadButNoNumber = /(ë¡œ|ê¸¸|ëŒ€ë¡œ|ë²ˆê¸¸)\b(?!\s*\d)/.test(cleaned);
    if(isOnlyDong || hasRoadButNoNumber){
      const reason = isOnlyDong ? 'ë™ë§Œ ê¸°ì¬ë¨' : 'ë„ë¡œëª…ì¸ë° ë²ˆì§€ê°€ ì—†ìŒ';
      log(`[ì˜¤ë¥˜] ${cleaned} â†’ ${reason}`);
      done++; setProgress(done,total, cleaned); continue;
    }

    // ì§„í–‰ì°½ì— í˜„ì¬ ì£¼ì†Œ í‘œì‹œ
    setProgress(done, total, cleaned);
    log(`ì§€ì˜¤ì½”ë”©: ${cleaned}`);

    const coord = await geocodeVWorld(cleaned);
    await sleep(200);

    if(coord){
      success++;
      const key = coord.join(',');
      if(!pointMap.has(key)) pointMap.set(key,{lat:coord[0],lon:coord[1],popupTexts:[],count:0});
      const p = pointMap.get(key);
      p.count++;
      const lines=[cleaned];
      if(gubun==='ì•„íŒŒíŠ¸' && dong) lines.push(`${dong}ë™`);
      if(suffix) lines.push(suffix);
      p.popupTexts.push(lines.join('<br>'));
      log(`ì„±ê³µ: ${cleaned} â†’ (${coord[0].toFixed(5)}, ${coord[1].toFixed(5)})`);
    }else{
      log(`[ì‹¤íŒ¨] ${cleaned} â†’ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    }
    done++; setProgress(done,total, cleaned);
  }

  const points = Array.from(pointMap.values());
  if(points.length){
    const center=[points[0].lat, points[0].lon];
    const schoolBlock = (schoolCoord && Array.isArray(schoolCoord)) ? {coord: schoolCoord, address: schoolAddr} : null;
    renderMap({center, zoom:14, points, school: schoolBlock});
    log(`âœ… ì™„ë£Œ: ì´ ${total}ê±´ / ì„±ê³µ ${success}ê±´ / ì‹¤íŒ¨ ${total-success}ê±´`);
  }else{
    const fb = (schoolCoord && Array.isArray(schoolCoord))
      ? {center: schoolCoord, zoom:14, points: [], school:{coord:schoolCoord,address:schoolAddr}}
      : {center:[37.5665,126.9780], zoom:12, points:[]};
    renderMap(fb);
    log('â›” í‘œì‹œí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
});
</script>
</body>
</html>
