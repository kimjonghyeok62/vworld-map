<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ (ì›¹ Â· ê³ ì†í™”)</title>

  <!-- Excel/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <style>
    :root{--bg:#0b1020;--panel:#11172c;--muted:#93a3c6;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:1.35rem;margin:0 0 8px}
    .hint{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input[type="text"], input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:var(--txt)}
    button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
    .progress{height:10px;background:#0f1530;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .bar{height:100%;background:linear-gradient(90deg,#688fff,#86a7ff)}
    .log{height:360px;overflow:auto;background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12.5px;white-space:pre}
    .note{color:#ffb4b4;white-space:pre-line}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#143268;color:#d7e4ff;font-size:.8rem;margin-left:.5rem}
    .footer{color:var(--muted);font-size:.85rem;margin-top:10px}
    .map-wrap{width:100vw}
    #map{width:100vw;height:100vh;background:#0f1530;border-top:1px solid var(--line);display:block}
    .leaflet-div-icon{background:transparent!important;border:0!important}

    /* Zoom ì»¨íŠ¸ë¡¤ ì˜¤ë¥¸ìª½ì— ë¼ë””ì˜¤ ì»¨íŠ¸ë¡¤ì„ ê°€ë¡œë¡œ ë°°ì¹˜ */
    .leaflet-top.leaflet-left{
      display:flex; gap:8px; align-items:flex-start;
      flex-direction: row; /* ê°€ë¡œ ì •ë ¬ */
    }

    /* ì§€ë„ ìœ„ ë² ì´ìŠ¤ë§µ ë¼ë””ì˜¤ ì»¨íŠ¸ë¡¤(Zoom ì˜¤ë¥¸ìª½, ì•½ê°„ ì‘ê²Œ) */
    .leaflet-control.basemap-control{
      background: rgba(17,23,44,.85);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 6px 8px;            /* ì‘ê²Œ */
      color: var(--txt);
      box-shadow: 0 6px 16px rgba(0,0,0,.30);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      font-size: 12px;             /* ì‘ê²Œ */
      margin-top: 0;               /* Zoomê³¼ ìˆ˜í‰ ì •ë ¬ */
    }
    .basemap-control .title{color: var(--muted);font-size: 11px;margin: 0 0 4px;letter-spacing:.02em;}
    .basemap-control .options{display:flex; gap:6px; align-items:center;}
    .basemap-control label.option{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 8px; border-radius:999px;     /* ì‘ê²Œ */
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      user-select:none; cursor:pointer;
      transition: border-color .15s, background .15s;
    }
    .basemap-control label.option:hover{ border-color:#5b8cff; background:rgba(91,140,255,.08); }
    .basemap-control input[type=radio]{ accent-color:#5b8cff; transform:scale(1.0); }

    .ghost-btn{ background:transparent; color:#cfe0ff; border:1px solid var(--line); font-weight:600; }
    .ghost-btn:hover{ border-color:#5b8cff; background:rgba(91,140,255,.08); }
    details.hint{background:#0f1530;border:1px solid var(--line);border-radius:10px;padding:10px}
    details.hint summary{cursor:pointer}
    .mini-table{border-collapse:collapse;font-size:.9rem;margin-top:8px}
    .mini-table td,.mini-table th{border:1px solid #2a3360;padding:6px 8px}
    .mini-table th{background:#0f1530}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ VWorld ì£¼ì†Œ ì§€ë„ í‘œì‹œ <span class="pill">ì›¹Â·ê³ ì†</span></h1>
    <div class="hint">ì—‘ì…€/CSVì˜ <b>ì£¼ì†Œ</b>(ì˜ˆ: <u>í•™ìƒì£¼ì†Œ</u>), <b>êµ¬ë¶„</b>(ì„ íƒ), <b>ë™</b>(ì„ íƒ)ì„ ì½ì–´ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤. í•™êµ ì£¼ì†ŒëŠ” ì…ë ¥ë€ ë˜ëŠ” ì—‘ì…€ <b>B2</b>(ì„ íƒ).</div>

    <div class="panel">
      <div class="hint">VWorld KeyëŠ” <code>Apps Script í”„ë¡ì‹œ</code>ì—ì„œ ë³´ê´€ë©ë‹ˆë‹¤.</div>

      <label>ë°ì´í„° íŒŒì¼ ì„ íƒ (xlsx / xls / csv)</label>
      <div class="row">
        <input id="file" type="file" accept=".xlsx,.xls,.csv"/>
        <button id="dlTplBtn" class="ghost-btn" type="button" title="ì—‘ì…€ í…œí”Œë¦¿ì„ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.">ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <details class="hint" style="margin-top:8px">
        <summary>ì–‘ì‹ ì•ˆë‚´(ì ‘ê¸°/í¼ì¹˜ê¸°)</summary>
        <div style="margin-top:8px">
          - <b>A1</b>: <code>í•™ìƒì£¼ì†Œ</code> (í•„ìˆ˜) Â· <b>A2~</b>: ì‹¤ì œ ì£¼ì†Œë“¤ ì…ë ¥<br>
          - <b>B1</b>: <code>í•™êµì£¼ì†Œ</code> (ì„ íƒ) Â· <b>B2</b>: ê¸°ì¤€ í•™êµ ì£¼ì†Œ 1ê±´ ì…ë ¥<br>
          <table class="mini-table">
            <tr><th>A</th><th>B</th></tr>
            <tr><td><b>í•™ìƒì£¼ì†Œ</b></td><td><b>í•™êµì£¼ì†Œ</b></td></tr>
            <tr><td>ê²½ê¸°ë„ ìš©ì¸ì‹œ ê¸°í¥êµ¬ â€¦</td><td>ê²½ê¸°ë„ ìš©ì¸ì‹œ â€¦(í•™êµì£¼ì†Œ)</td></tr>
            <tr><td>ê²½ê¸°ë„ ìš©ì¸ì‹œ ì²˜ì¸êµ¬ â€¦</td><td></td></tr>
          </table>
          â€» CSV ì—…ë¡œë“œ ì‹œì—ëŠ” <b>B2</b>ë¥¼ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì•„ë˜ â€œí•™êµ ê¸°ì¤€ ì£¼ì†Œâ€ ì…ë ¥ë€ì„ ì‚¬ìš©í•˜ì„¸ìš”.
        </div>
      </details>

      <label style="margin-top:10px">í•™êµ ê¸°ì¤€ ì£¼ì†Œ (ì„ íƒ)</label>
      <input id="schoolAddr" type="text" placeholder="ì…ë ¥ ì‹œ ë°˜ê²½/ê±°ë¦¬ ë¼ë²¨ í‘œì‹œ"/>

      <div class="row" style="margin-top:12px">
        <button id="runBtn">ì§€ë„ì— í‘œì‹œ</button>
        <button id="clearBtn">ë¡œê·¸ ì§€ìš°ê¸°</button>
      </div>

      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      <div id="progLabel" class="hint" style="margin-top:6px"></div>

      <div class="note" style="margin-top:12px">âš ï¸ ì£¼ì˜
- ë„ë¡œëª…ì¸ë° ë²ˆì§€(ìˆ«ì) ì—†ìœ¼ë©´ ì˜¤ë¥˜
- ë‹¨ì§€ëª…ë§Œì€ ë¶ˆê°€
- ë™/í˜¸ìˆ˜ëŠ” ë¬´ì‹œë˜ê³  â€˜ë™â€™ ë‹¨ìœ„ë¡œ í•©ì‚°
- <b>ë³‘ë ¬ ì§€ì˜¤ì½”ë”©</b>(ê¸°ë³¸ ë™ì‹œ 10ê±´)</div>

      <div id="log" class="log" style="margin-top:12px"></div>
      <div class="footer">Leaflet + VWorld(í”„ë¡ì‹œ) Â· ì•„ë˜ ë‚´ì¥ ì§€ë„ì— ë Œë”ë§</div>
    </div>
  </div>

  <div class="map-wrap"><div id="map"></div></div>

<script>
/* Apps Script ì›¹ì•±(/exec) URL */
const PROXY_BASE = 'https://script.google.com/macros/s/AKfycbwELVvtv8iNqyn6ltYMY2hr77w8F_Ksy34TDi9kMj6Qy5runtboRU6QSWlTjBAHzo5z/exec';

const $ = s => document.querySelector(s);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* -------- ë¡œê·¸ ë°°ì¹˜ ì¶œë ¥(50msë§ˆë‹¤ flush) -------- */
let _logBuf = [];
let _logTimer = null;
function log(msg){
  const t = new Date().toLocaleTimeString();
  _logBuf.push(`[${t}] ${msg}\n`);
  if(!_logTimer){
    _logTimer = setInterval(()=>{
      if(_logBuf.length===0) return;
      const el = $('#log');
      el.textContent += _logBuf.join('');
      _logBuf = [];
      el.scrollTop = el.scrollHeight;
    }, 50);
  }
}
function stopLogFlush(){
  if(_logTimer){ clearInterval(_logTimer); _logTimer=null; }
}
function setProgress(done,total,current){
  const pct = total? Math.round(done/total*100):0;
  $('#bar').style.width = pct+'%';
  $('#progLabel').innerHTML = total
    ? `ì§„í–‰ë¥ : ${done}/${total} (${pct}%)` + (current? `<br>í˜„ì¬: <code>${esc(current)}</code>`:'')
    : '';
}

/* -------- ì£¼ì†Œ ì „ì²˜ë¦¬/ë„ë©”ì¸ ë¡œì§ -------- */
function clean_address(a){
  a = String(a||'');
  a = a.replace(/\d+\s*ë™\s*\d+\s*í˜¸/g,'');
  a = a.replace(/\d+\s*ë™/g,'');
  a = a.replace(/\d+\s*í˜¸/g,'');
  a = a.replace(/[()]/g,' ');
  a = a.replace(/,/g,' ');
  a = a.replace(/\s+/g,' ').trim();
  return a;
}
function is_road_address(a){
  const road_keywords = ["ë¡œ","ê¸¸","ëŒ€ë¡œ","ê³ ê°€","ë‚˜ë“¤ëª©","ìˆœí™˜ë¡œ","ë¡œí„°ë¦¬","ë²ˆê¸¸"];
  const tokens = String(a||'').split(/\s+/);
  return tokens.some(tok => road_keywords.some(k => tok.endsWith(k)));
}
function shorten_address(a){
  return String(a||'').replace(/^(ê²½ê¸°|ê²½ê¸°ë„|ì„œìš¸|ì„œìš¸íŠ¹ë³„ì‹œ|ë¶€ì‚°|ë¶€ì‚°ê´‘ì—­ì‹œ|ëŒ€êµ¬|ëŒ€êµ¬ê´‘ì—­ì‹œ|ì¸ì²œ|ì¸ì²œê´‘ì—­ì‹œ|ê´‘ì£¼|ê´‘ì£¼ê´‘ì—­ì‹œ|ëŒ€ì „|ëŒ€ì „ê´‘ì—­ì‹œ|ìš¸ì‚°|ìš¸ì‚°ê´‘ì—­ì‹œ|ì„¸ì¢…|ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ|ì œì£¼|ì œì£¼íŠ¹ë³„ìì¹˜ë„)\s*(ë„\s*)?(?:ìš©ì¸ì‹œ|ê´‘ì£¼ì‹œ|í•˜ë‚¨ì‹œ|ì„±ë‚¨ì‹œ|ìˆ˜ì›ì‹œ|ê³ ì–‘ì‹œ|ë¶€ì²œì‹œ|ì•ˆì–‘ì‹œ|ì•ˆì‚°ì‹œ|ë‚¨ì–‘ì£¼ì‹œ|í™”ì„±ì‹œ|í‰íƒì‹œ)?\s*/,'').trim();
}
function extract_dong_counts(popup_texts){
  const m = new Map();
  (popup_texts||[]).forEach(t=>{ const x=String(t).match(/(\d{2,4}ë™)/); if(x){ m.set(x[1],(m.get(x[1])||0)+1); } });
  return m;
}
function build_tooltip_text(popup_texts){
  if(!popup_texts?.length) return '';
  const main_only = popup_texts[0].split('<br>')[0];
  const first = shorten_address(main_only);
  const total = popup_texts.length;
  const dm = extract_dong_counts(popup_texts);
  if(!dm.size) return `${first} [ì´ ${total}ê±´]`;
  const items = Array.from(dm.entries()).map(([d,c])=>`- ${d}: ${c}ê±´`);
  const lines=[]; for(let i=0;i<items.length;i+=2) lines.push(items.slice(i,i+2).join(',  '));
  return `${first} [ì´ ${total}ê±´]<br>`+lines.join('<br>');
}

/* -------- ì—‘ì…€ í…œí”Œë¦¿ -------- */
function downloadTemplateXLSX(){
  const wb = XLSX.utils.book_new();
  const data = [['í•™ìƒì£¼ì†Œ','í•™êµì£¼ì†Œ'], ['', '']];
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!freeze'] = { xSplit:0, ySplit:1 };
  ws['!cols'] = [{ wch: 42 }, { wch: 42 }];
  XLSX.utils.book_append_sheet(wb, ws, 'ì£¼ì†Œì…ë ¥');
  XLSX.writeFile(wb, 'ì—…ë¡œë“œ_í• _ì£¼ì†Œ(ì–‘ì‹).xlsx');
}

/* -------- ì§€ì˜¤ì½”ë”©(ê³ ì†Â·ë™ì‹œì„± ì œí•œÂ·ìºì‹œ) -------- */
const _geoCache = new Map(); // cleaned -> [lat,lon] | null(ì‹¤íŒ¨ ìºì‹œ)
async function geocodeOnce(address){
  // ìºì‹œ
  if(_geoCache.has(address)) return _geoCache.get(address);

  const primary = is_road_address(address) ? 'road' : 'parcel';
  const order = primary==='road' ? ['road','parcel'] : ['parcel','road'];

  for (const type of order){
    const u = new URL(PROXY_BASE);
    u.searchParams.set('address', address);
    u.searchParams.set('type', type);
    u.searchParams.set('_ts', Date.now()); // ìºì‹œ íšŒí”¼
    try{
      const res = await fetch(u.toString(), { method:'GET', cache:'no-store' });
      const data = await res.json();
      if (data?.response?.status === 'OK' && data?.response?.result?.point){
        const p = data.response.result.point;
        if (data?.response?.refined?.text) log(`â†³ ë§¤ì¹­: ${data.response.refined.text}`);
        const coord = [parseFloat(p.y), parseFloat(p.x)];
        _geoCache.set(address, coord);
        return coord;
      }
    }catch(e){
      // ë„¤íŠ¸ì›Œí¬ ì˜ˆì™¸ëŠ” ë‹¤ìŒ ìˆœì„œë¡œ í´ë°± ì‹œë„
    }
  }
  _geoCache.set(address, null);
  return null;
}

/* ë™ì‹œì„± ì œí•œ ì‹¤í–‰ê¸° */
async function mapLimit(items, limit, iterator){
  const ret = [];
  let idx = 0, running = 0;
  return await new Promise((resolve)=>{
    const next = ()=>{
      if(idx === items.length && running === 0) return resolve(ret);
      while(running < limit && idx < items.length){
        const cur = idx++; running++;
        Promise.resolve(iterator(items[cur], cur))
          .then(v => ret[cur]=v)
          .catch(e => ret[cur]=undefined)
          .finally(()=>{ running--; next(); });
      }
    };
    next();
  });
}

/* -------- ì§€ë„/ë² ì´ìŠ¤ë§µ -------- */
let MAP=null, MAP_LAYER=null, CANVAS_RENDERER=null;
let BASE_OSM=null, BASE_SAT=null, CURRENT_BASE=null;
let BASEMAP_RADIOS=null;
let CURRENT_MODE='osm';            // 'osm' | 'sat'

/* ë§ˆì»¤ ì°¸ì¡° ì €ì¥(ë² ì´ìŠ¤ë§µ ë³€ê²½ ì‹œ ì¦‰ì‹œ ìŠ¤íƒ€ì¼ ë³€ê²½) */
const POINT_MARKERS=[]; // { marker, count, r }

/* ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„± (ë² ì´ìŠ¤ë§µì— ë”°ë¼ ìƒ‰ìƒ ì „í™˜) */
function createMarkerIcon(count, r, mode){
  const isSat = (mode==='sat');
  const textColor = isSat ? '#000' : '#fff';
  const textShadow = isSat ? '0 1px 1px rgba(255,255,255,.35)' : '0 1px 2px rgba(0,0,0,.6)';
  const bg = isSat
    ? 'radial-gradient(circle at 35% 30%, #ffe066 0%, #ffcc00 45%, #d4a200 100%)'  // yellow
    : 'radial-gradient(circle at 35% 30%, #3a6cff 0%, #1f50ff 45%, #0032cc 100%)'; // blue
  const boxShadow = isSat ? '0 3px 12px rgba(0,0,0,.35)' : '0 3px 12px rgba(0,0,0,.35)';

  const html = `
    <div style="
      width:${r*2}px;height:${r*2}px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:${Math.max(11, r*0.9)}px;
      color:${textColor};text-shadow:${textShadow};
      background:${bg};
      box-shadow:${boxShadow};
    ">${count>1 ? count : ''}</div>`;
  return L.divIcon({ className:'', iconSize:[r*2,r*2], iconAnchor:[r,r], html });
}

/* ë² ì´ìŠ¤ë§µ ì „í™˜ ì‹œ ë§ˆì»¤ ì™¸í˜• ê°±ì‹  */
function refreshMarkerStyles(mode){
  for(const it of POINT_MARKERS){
    const icon = createMarkerIcon(it.count, it.r, mode);
    it.marker.setIcon(icon);
  }
}

function setBasemap(mode){
  if(!MAP) return;
  if(CURRENT_BASE) MAP.removeLayer(CURRENT_BASE);
  CURRENT_BASE = (mode==='sat') ? BASE_SAT : BASE_OSM;
  CURRENT_BASE.addTo(MAP);
  CURRENT_MODE = mode;
  if(BASEMAP_RADIOS){ BASEMAP_RADIOS.forEach(r => r.checked = (r.value === mode)); }
  refreshMarkerStyles(mode); // â˜… ë§ˆì»¤ ìƒ‰ìƒ ì¦‰ì‹œ ë³€ê²½
}

function addBasemapControl(){
  const Control = L.Control.extend({
    options:{position:'topleft'},  // Zoom ì˜¤ë¥¸ìª½ì— ê°€ë¡œ ë°°ì¹˜(CSSë¡œ ì •ë ¬)
    onAdd: function(map){
      const div = L.DomUtil.create('div','leaflet-control basemap-control');
      div.innerHTML = `
        <div class="title">ì§€ë„ ìœ í˜•</div>
        <div class="options">
          <label class="option"><input type="radio" name="bm" value="osm" checked> ì¼ë°˜</label>
          <label class="option"><input type="radio" name="bm" value="sat"> ìœ„ì„±</label>
        </div>`;
      L.DomEvent.disableClickPropagation(div);
      BASEMAP_RADIOS = div.querySelectorAll('input[name="bm"]');
      BASEMAP_RADIOS.forEach(r=>r.addEventListener('change', e => setBasemap(e.target.value)));
      return div;
    }
  });
  (new Control()).addTo(MAP);
}

function ensureMap(center=[37.5665,126.9780], zoom=12){
  if(!MAP){
    CANVAS_RENDERER = L.canvas({ padding: 0.5 }); // ìº”ë²„ìŠ¤ ë Œë”ëŸ¬(ì›Â·ì„  ë“± ê°€ì†)
    MAP = L.map('map', { preferCanvas: true }).setView(center, zoom);
    BASE_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'});
    BASE_SAT = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {maxZoom:19, attribution:'Tiles &copy; Esri â€” Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'});
    CURRENT_BASE = BASE_OSM.addTo(MAP);
    MAP_LAYER = L.layerGroup().addTo(MAP);
    addBasemapControl(); setBasemap('osm');
    window.addEventListener('resize', ()=>setTimeout(()=>MAP.invalidateSize(), 50));
    setTimeout(()=>MAP.invalidateSize(), 50);
  }
}

/* -------- ë Œë”ë§ -------- */
function renderMap(payload){
  ensureMap(payload.center||[37.5665,126.9780], payload.zoom||13);
  MAP_LAYER.clearLayers();
  POINT_MARKERS.length = 0; // ë§ˆì»¤ ë ˆí¼ëŸ°ìŠ¤ ì´ˆê¸°í™”

  // ë°˜ê²½í‘œì‹œ(ìº”ë²„ìŠ¤)
  if(payload.school && payload.school.coord){
    const [slat, slon] = payload.school.coord;
    const ranges=[500,1000,1500,2000,2500];
    const counts=new Map(ranges.map(r=>[r,0]));
    const hav=(a,b)=>{const R=6371000,toRad=d=>d*Math.PI/180;const dLat=toRad(b[0]-a[0]),dLon=toRad(b[1]-a[1]);const lat1=toRad(a[0]),lat2=toRad(b[0]);const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};
    (payload.points||[]).forEach(p=>{ const d=hav([slat,slon],[p.lat,p.lon]); for(const r of ranges){ if(d<=r){ counts.set(r, counts.get(r)+p.count); break; } } });
    ranges.forEach(r=>{
      L.circle([slat, slon], { radius:r, color:'#666', weight:2, dashArray:'6 4', fill:false, renderer:CANVAS_RENDERER }).addTo(MAP_LAYER);
      const labelLat = slat + (r/1000)/111;
      const txt = r>=1000 ? (r/1000).toFixed(1)+`km (${counts.get(r)}ê±´)` : r+`m (${counts.get(r)}ê±´)`;
      L.marker([labelLat, slon], {icon:L.divIcon({className:'', html:`<div style="font-size:18px;font-weight:bold;white-space:nowrap;color:black">${txt}</div>`})}).addTo(MAP_LAYER);
    });
    L.circleMarker([slat,slon], {radius:6,color:'red',fill:true,fillColor:'red',fillOpacity:1, renderer:CANVAS_RENDERER}).bindTooltip('í•™êµ ê¸°ì¤€ì ',{sticky:true}).addTo(MAP_LAYER);
  }

  // í¬ì¸íŠ¸ (ì¤‘ì²© ì¹´ìš´íŠ¸ ë°˜ì˜)
  const latlngs=[];
  (payload.points||[]).forEach(p=>{
    latlngs.push([p.lat,p.lon]);

    const SCALE=0.5, BASE_R=8, MIN_R=4, MAX_R=28;
    let r = BASE_R * Math.sqrt(Math.max(1, p.count)) * SCALE;
    r = Math.max(MIN_R, Math.min(MAX_R, r));

    const popupHtml = '<ul style="margin:0;padding-left:16px">'+(p.popupTexts||[]).map(t=>'<li>'+t+'</li>').join('')+'</ul>';
    const tip = build_tooltip_text(p.popupTexts||[]);

    const icon = createMarkerIcon(p.count, r, CURRENT_MODE);
    const marker = L.marker([p.lat,p.lon], {icon})
      .bindPopup(popupHtml, {maxWidth:300})
      .bindTooltip('<div style="font-size:14px;font-family:\'ë§‘ì€ ê³ ë”•\'">'+tip+'</div>', {sticky:true})
      .addTo(MAP_LAYER);

    POINT_MARKERS.push({ marker, count:p.count, r });
  });

  if(latlngs.length===1) MAP.setView(latlngs[0], payload.zoom||14);
  else if(latlngs.length>1) MAP.fitBounds(latlngs,{padding:[30,30]});
  setTimeout(()=>MAP.invalidateSize(), 50);
}

/* -------- íŒŒì¼ ë¡œë”© -------- */
async function readRowsFromFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(['xlsx','xls'].includes(ext)){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
    let b2=''; try{ b2=(ws['B2']&&ws['B2'].v)? String(ws['B2'].v).trim():''; }catch{}
    return {rows, b2};
  }else if(ext==='csv'){
    const text = await file.text(); const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
    return {rows: parsed.data, b2: ''};
  }else{ throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.'); }
}

/* -------- ì‹¤í–‰ -------- */
$('#dlTplBtn').addEventListener('click', downloadTemplateXLSX);
$('#clearBtn').addEventListener('click', ()=>{ $('#log').textContent=''; $('#bar').style.width='0%'; $('#progLabel').textContent=''; });

$('#runBtn').addEventListener('click', async()=>{
  ensureMap(); $('#map').scrollIntoView({behavior:'smooth', block:'start'});
  const f = $('#file').files[0]; if(!f){ alert('ë°ì´í„° íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
  $('#log').textContent=''; setProgress(0,0); log('ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');

  let rows, b2; try{ const r=await readRowsFromFile(f); rows=r.rows; b2=r.b2||''; } catch(e){ alert(e.message); return; }

  let schoolAddr = ($('#schoolAddr').value||'').trim();
  if(!schoolAddr && b2){ schoolAddr=b2; log(`ì—‘ì…€ B2ì—ì„œ í•™êµ ì£¼ì†Œ ê°ì§€: ${schoolAddr}`); }

  const norm = s=>String(s||'').replace(/\s+/g,'').toLowerCase();
  const head = rows.length? Object.keys(rows[0]) : [];

  function findAddrHeader(headers){
    const exactOrder = ['í•™ìƒì£¼ì†Œ','ì£¼ì†Œ','address'];
    for(const key of exactOrder){ const found = headers.find(h => norm(h) === norm(key)); if(found) return found; }
    let found = headers.find(h => /í•™ìƒ.*ì£¼ì†Œ/i.test(h)); if(found) return found;
    found = headers.find(h => /ì£¼ì†Œ$/i.test(h) && !/í•™êµ/i.test(h)); if(found) return found;
    found = headers.find(h => /ì£¼ì†Œ/i.test(h) && !/í•™êµ/i.test(h));
    return found || 'ì£¼ì†Œ';
  }
  const colAddr = findAddrHeader(head);
  const colGubun= head.find(h=>['êµ¬ë¶„','category','type'].includes(norm(h))) || 'êµ¬ë¶„';
  const colDong = head.find(h=>['ë™','building','dong'].includes(norm(h))) || 'ë™';

  // í•™êµ ì¢Œí‘œ(ìˆìœ¼ë©´)
  let schoolCoord=null;
  if(schoolAddr){
    log(`í•™êµ ê¸°ì¤€ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©: ${schoolAddr}`);
    schoolCoord = await geocodeOnce(clean_address(schoolAddr));
    if(!schoolCoord) log('í•™êµ ì£¼ì†Œ ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ë°˜ê²½/ê±°ë¦¬ ë¼ë²¨ì€ ìƒëµë©ë‹ˆë‹¤.');
  }

  // 1) ì£¼ì†Œ ì •ì œ + ìœ íš¨ì„± ê²€ì‚¬ + ê·¸ë£¹í™”(ë™ì¼ cleaned ì£¼ì†Œ ë¬¶ê¸°)
  const groups = new Map(); // cleaned -> [{gubun,dong,orig}]
  let skipped = 0;
  rows.forEach((row, i)=>{
    const raw = String(row[colAddr]||'').trim();
    if(!raw){ skipped++; return; }
    const gubun = String(row[colGubun]||'').trim();
    const dong  = String(row[colDong]||'').trim();
    const cleaned = clean_address(raw);

    const tokens = cleaned.split(/\s+/);
    const last = tokens[tokens.length-1]||'';
    const isOnlyDong = (cleaned.endsWith('ë™') && tokens.length===1) || (last.endsWith('ë™') && !/\d/.test(last));
    const hasRoadButNoNumber = is_road_address(cleaned) && !/\b\d{1,5}\b/.test(cleaned);
    if(isOnlyDong || hasRoadButNoNumber){ skipped++; log(`[ì˜¤ë¥˜] ${cleaned} â†’ ${isOnlyDong?'ë™ë§Œ ê¸°ì¬ë¨':'ë„ë¡œëª…ì¸ë° ë²ˆì§€ê°€ ì—†ìŒ'}`); return; }

    if(!groups.has(cleaned)) groups.set(cleaned, []);
    groups.get(cleaned).push({ gubun, dong, orig: raw });
  });

  const uniqueAddresses = Array.from(groups.keys());
  const totalUnique = uniqueAddresses.length;
  if(totalUnique===0){
    const fb = (schoolCoord && Array.isArray(schoolCoord))
      ? {center:schoolCoord, zoom:14, points:[], school:{coord:schoolCoord,address:schoolAddr}}
      : {center:[37.5665,126.9780], zoom:12, points:[]};
    renderMap(fb);
    log(`â›” í‘œì‹œí•  ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. (ë¹ˆí–‰/í˜•ì‹ì˜¤ë¥˜ ì œì™¸ ${skipped}ê±´)`);
    stopLogFlush();
    return;
  }

  log(`ê³ ìœ  ì£¼ì†Œ ${totalUnique}ê±´ ì§€ì˜¤ì½”ë”© ì‹œì‘ (ë™ì‹œ 10ê±´)â€¦`);
  setProgress(0,totalUnique);

  // 2) ê³ ìœ  ì£¼ì†Œ ë³‘ë ¬ ì§€ì˜¤ì½”ë”© (ë™ì‹œì„± ì œí•œ)
  const CONCURRENCY = 10; // í•„ìš” ì‹œ 6~12 ì‚¬ì´ë¡œ ì¡°ì ˆ
  let done=0, success=0;
  const coordMap = new Map(); // cleaned -> [lat,lon] | null

  await mapLimit(uniqueAddresses, CONCURRENCY, async (addr, idx)=>{
    log(`ì§€ì˜¤ì½”ë”©: ${addr}`);
    const coord = await geocodeOnce(addr);
    coordMap.set(addr, coord);
    if(coord){ success++; log(`ì„±ê³µ: ${addr} â†’ (${coord[0].toFixed(5)}, ${coord[1].toFixed(5)})`); }
    else{ log(`[ì‹¤íŒ¨] ${addr} â†’ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); }
    done++; setProgress(done, totalUnique, addr);
  });

  // 3) ì¢Œí‘œë³„ ì§‘ê³„(ì—¬ëŸ¬ í–‰â†’í•œ ì¢Œí‘œë¡œ)
  const pointMap = new Map(); // "lat,lon" -> {lat,lon,popupTexts,count}
  for(const [addr, rowsArr] of groups.entries()){
    const coord = coordMap.get(addr);
    if(!coord) continue;
    const key = coord.join(',');
    if(!pointMap.has(key)) pointMap.set(key, {lat:coord[0],lon:coord[1],popupTexts:[],count:0});
    const p = pointMap.get(key);
    rowsArr.forEach(({gubun,dong})=>{
      p.count++;
      const lines=[addr];
      if(gubun==='ì•„íŒŒíŠ¸' && dong) lines.push(`${dong}ë™`);
      p.popupTexts.push(lines.join('<br>'));
    });
  }

  const points = Array.from(pointMap.values());
  if(points.length){
    const center=[points[0].lat, points[0].lon];
    const schoolBlock = (schoolCoord && Array.isArray(schoolCoord)) ? {coord:schoolCoord, address:schoolAddr} : null;
    renderMap({center, zoom:14, points, school: schoolBlock});
    log(`âœ… ì™„ë£Œ: ê³ ìœ  ${totalUnique}ê±´ / ì„±ê³µ ${success}ê±´ / ì‹¤íŒ¨ ${totalUnique-success}ê±´ / ìŠ¤í‚µ ${skipped}ê±´`);
  }else{
    const fb = (schoolCoord && Array.isArray(schoolCoord))
      ? {center:schoolCoord, zoom:14, points:[], school:{coord:schoolCoord,address:schoolAddr}}
      : {center:[37.5665,126.9780], zoom:12, points:[]};
    renderMap(fb);
    log('â›” í‘œì‹œí•  ìˆ˜ ìˆëŠ” ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
  }

  stopLogFlush();
});

// ì´ˆê¸° ë°”ì¸ë”©
document.addEventListener('DOMContentLoaded', ()=>{
  // no-op
});
</script>
</body>
</html>
